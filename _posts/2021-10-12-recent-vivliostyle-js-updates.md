---
title: Recent Vivliostyle.js updates
lang: en
image: /assets/posts/2021-10-12-recent-vivliostyle-js-updates/fig-1.png
author:
 - ogwata
tags:
 - Release
 - Vivliostyle Core
 - Vivliostyle Viewer
---
<div style="float: right; margin: 0 0 1em 1em;"><img src="/assets/posts/2021-10-12-recent-vivliostyle-js-updates/fig-1.png" alt="Recent Vivliostyle.js updates" style="width: 700px;" /></div>

Over the past month, Vivliostyle.js has been undergoing a series of important updates. It was v2.8.1 until early September, and now it is v2.11.1. An overview can be found in the [Change Log](https://github.com/vivliostyle/vivliostyle.js/blob/master/CHANGELOG.md). This article describes the useful features that have been added, the impact of the bug fixes on the typesetting results, and concludes with a preview of the features that will be implemented in the near future.

## Added CSS functionality

 - [v2.9.0](https://github.com/vivliostyle/vivliostyle.js/blob/master/CHANGELOG.md#290-2021-09-03)
    - [@supports](https://developer.mozilla.org/ja/docs/Web/CSS/@supports)……You can switch styles based on whether a particular CSS property, or combination of properties and values, is supported
- [v2.10.0](https://github.com/vivliostyle/vivliostyle.js/blob/master/CHANGELOG.md#2100-2021-09-17)
    - [line-break: anywhere](https://developer.mozilla.org/ja/docs/Web/CSS/line-break)……Allow line breaks between all characters, including punctuation and spaces.
    - [overflow-wrap: anywhere](https://developer.mozilla.org/ja/docs/Web/CSS/overflow-wrap)……To prevent text from overflowing the line box for inline elements, line breaks are intentionally added where they would not normally be.
    - [white-space: break-spaces](https://developer.mozilla.org/ja/docs/Web/CSS/white-space)……Defines the handling of whitespace in strings within an element, similar to `white-space: pre-wrap`, but also breaks lines between consecutive whitespaces.
    - [font-variant-caps](https://developer.mozilla.org/ja/docs/Web/CSS/font-variant-caps)……Controls uppercase related glyphs in Latin fonts in OpenType format.
    - [font-variant-ligatures](https://developer.mozilla.org/ja/docs/Web/CSS/font-variant-ligatures)……Controls the glyphs of ligatures in OpenType fonts.
    - [font-variant-numeric](https://developer.mozilla.org/ja/docs/Web/CSS/font-variant-numeric)……Controls the glyphs of numbers, fractions, and ordinal symbols in OpenType fonts.
    - [min-content](https://developer.mozilla.org/en-US/docs/Web/CSS/min-content)……For automatic line breaks within a box, the box will be generated for the word with the longest word length to minimize the width of the box.
    - [max-content](https://developer.mozilla.org/en-US/docs/Web/CSS/max-content)……Generates a box without automatic line breaks so that the content is at its maximum width.
    - [fit-content](https://developer.mozilla.org/en-US/docs/Web/CSS/fit-content)……In the case where the available area is variable, the box is first generated using max-content, and if the available area is less than the width of max-content, the box is generated by switching to the larger of the available area and min-content.
    - [unicode-range](https://developer.mozilla.org/ja/docs/Web/CSS/@font-face/unicode-range)…… Specifies a specific code point in the font defined by `@font-face`.

The last one, `unicode-range`, is particularly noteworthy. This makes it possible, for example, to use different fonts for Latin and Japanese, or to specify a different font for a particular character or punctuation. Also, when specifying Chinese or Japanese web fonts, you can use this feature to create a subset of glyphs to reduce capacity and improve display speed.

## Added text search function to Vivliostyle Viewer UI

Look at the Vivliostyle Viewer screenshot at the top of this page. You can see a magnifying glass icon in the upper left corner of the screen. This is the new text search icon.You can actually use the latest version of Vivliostyle Viewer from below.

- [Vivliostyle で本を作ろう Vol.5](https://vivliostyle.org/viewer/#src=https://vivliostyle.github.io/vivliostyle_doc/ja/vivliostyle-user-group-vol5/content/&bookMode=true)

## Impact of bug fixes on typesetting results

###  Changed the value of `margin` for `body` in the default style sheet from 8px to 0

<div style="float: right; margin: 0 0 1em 1em;"><img src="/assets/posts/2021-10-12-recent-vivliostyle-js-updates/fig-2.png" alt="Changed the value of margin for body in the default style sheet from 8px to 0" /></div>

From the beginning, Vivliostyle.js has defined a `margin` value of 8px for the `body` in the [default style sheet](https://github.com/vivliostyle/vivliostyle.js/blob/v2.9.1/packages/core/src/vivliostyle/assets.ts#L1064) for user agents. This setting follows the default value of web browsers.

ところが、[CSS Paged Media Module Level 3](https://www.w3.org/TR/css-page-3/)では、ページのマージンを`@page {...}`の`margin`プロパティによって指定することになっています。これにもとづき、VivliostyleをふくむほとんどのCSS Paged Media実装は、デフォルトスタイルシートで`@page { margin: 10% }`を設定しています。

However, in [CSS Paged Media Module Level 3](https://www.w3.org/TR/css-page-3/), the page margin is specified by the `margin` property of `@page {...}`. Based on this, most CSS Paged Media implementations, including Vivliostyle, set `@page {margin: 10%}` in the default stylesheet. 


そうした中、Vivliostyle.jsだけが加えて`body { margin: 8px; }`を設定するのは意味がありません。さらに言えば、Vivliostyle.jsのユーザはページ領域内の余分な余白を避けるため、常に`body { margin: 0 }`を指定なければなりませんでした。

つまり、今までVivliostyle.jsが設定してきたデフォルトスタイルシートの`body { margin: 8px; }`は、CSS Paged Mediaの実装には適していないと言えます。この状況を修正するため、v2.10.0で、このデフォルトスタイルシートの設定を削除しました（`margin`のデフォルトは0になります）。

スクリーンショットをご覧ください。意図的にマージンをなくすよう`@page {margin: 0;}`を指定したのに、左側のv2.9.1の緑色枠の外側には8pxの間隔が発生しています（現物は[こちら](https://vivliostyle.github.io/viewer/v2.9.1/#src=https://github.com/ogwata/testbed-20211012/blob/main/test.html)）。それに対し、右側のv2.10.0では指定通り間隔はゼロであることが分かります（現物は[こちら](https://vivliostyle.github.io/viewer/v2.10.0/#src=https://github.com/ogwata/testbed-20211012/blob/main/test.html)。コードは[こちら](https://github.com/ogwata/testbed-20211012/blob/main/test.html)）。

この修正により、v2.10.0の前後で組版結果が異なる可能性があります。Vivliostyle.jsを組み込んだ Vivliostyle Viewer、Vivliostyle CLI、Create Bookを、以前からお使いのユーザは、お手元のデータに影響がないか、一度ご確認ください。詳細は下記のIssueを参照してください。

- [ Default body margin should be 0 in paged media #776 ](https://github.com/vivliostyle/vivliostyle.js/issues/776)

### ルート要素で指定された継承プロパティを、`@page`の内容に継承できるよう修正

これもスクリーンショットで比較してみましょう。まず、ルート要素の中で以下のように記述したHTMLを用意します（コード全体は[こちら](https://github.com/ogwata/testbed-20211012/blob/main/test-2.html)）。`root`セレクタにより、文字に関するスタイル（色、フォント名、バリアント、サイズ等）を指定しています。これらは[継承プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/inheritance#inherited_properties)ですので、続く`@page`で指定されたヘッダとフッタに継承されるはずです。

```css
:root {
  color: maroon;
  font-family: "Georgia", serif;
  font-variant: small-caps;
  font-style: italic;
  font-size: 200%;
}
@page {
  @top-center {
    content: "Here is the Page Header";
  }
  @bottom-center {
    content: counter(page);
  }
}
```

これを修正前後のVivliostyle Viewerに読み込ませたスクリーンショットをご覧ください。左側は[修正前のv2.9.1](https://vivliostyle.github.io/viewer/v2.9.1/#src=https://ogwata.github.io/testbed-20211012/test-2)（現物は[こちら](https://vivliostyle.github.io/viewer/v2.9.1/#src=https://ogwata.github.io/testbed-20211012/test-2)）、右側は[修正したv2.10.0](https://vivliostyle.github.io/viewer/v2.10.0/#src=https://ogwata.github.io/testbed-20211012/test-2)です（現物は[こちら](https://vivliostyle.github.io/viewer/v2.10.0/#src=https://ogwata.github.io/testbed-20211012/test-2)）。

<div style="float: right; margin: 0 0 1em 1em;"><img src="/assets/posts/2021-10-12-recent-vivliostyle-js-updates/fig-3.png" alt="body`における`margin`のデフォルト値を8から0に変更" style="width: 1200px; " /></div>

画面の上端のヘッダと下端のフッタを左右で比べてください。左側の旧バージョンでは本来継承されるはずの文字に関するスタイルが有効にならず、ただヘッダとフッタの内容、位置だけが表示されてしまっています。これはぜひ直したいバグです。そこで右側の新バージョンをみると、ヘッダとフッタは指定通り、適切に表示されていることが分かります。

この修正によって、前項と同じくv2.10.0の前後で組版結果が異なる可能性があります。以前からVivliostyle Viewer、Vivliostyle CLI、Create Bookをお使いのユーザは、お手元のデータに影響がないか、一度ご確認ください。詳細は下記のIssueを参照してください。

- [Root element styles are not inherited to page context #568](https://github.com/vivliostyle/vivliostyle.js/issues/568)

## 直近のアップデート予定

最後に、 この1ヵ月くらいに予定されている機能追加について、簡単にご紹介しましょう。

- [CSS Text Level 4: text-spacing](https://drafts.csswg.org/css-text-4/#text-spacing-property)……日本語フォントにおける連続約物の詰めや、和欧文間のアキの調整
- [CSS Grid Layout](https://developer.mozilla.org/ja/docs/Web/CSS/CSS_Grid_Layout)……画面を複数のグリッドに分割することで、要素を列と行に整列させられる
- WebフォントにおけるJavaScript 埋め込みコードをサポート……容量が大きくなりがちな東アジアフォントに多い、JavaScript 埋め込みコードによるWebフォントの指定をサポートする予定です（なお、現在でも`@import`埋め込みコードや、`link`要素による指定はサポートされています）

以上、駆け足で紹介しましたが、来月11月13日（土曜）に開催予定の「Vivliostyle ユーザーと開発者の集い 2021秋」では、村上代表がVivliostyle.jsのアップデートについて、デモを交えながら詳しく説明する予定です。近日中にイベント告知を開始しますので、どうかお楽しみに！